// leitor de qr code
const qrcode = require('qrcode-terminal');
const { Client, Buttons, List, MessageMedia } = require('whatsapp-web.js'); // Mudança Buttons
const client = new Client();
// serviço de leitura do qr code
client.on('qr', qr => {
    qrcode.generate(qr, { small: true });
});
// apos isso ele diz que foi tudo certo
client.on('ready', () => {
    console.log('Tudo certo! WhatsApp conectado.');
});
// E inicializa tudo 
client.initialize();

const delay = ms => new Promise(res => setTimeout(res, ms)); // Função que usamos para criar o delay entre uma ação e outra

// Funil

let status = 'off'; // Variável global que armazena o status

client.on('message', async msg => {

    if (msg.body.match(/(menu|Menu|dia|tarde|noite|oi|Oi|Olá|olá|ola|Ola)/i) && msg.from.endsWith('@c.us')) {
        status = 'on'; // Se alguma palavra-chave for encontrada, o status é alterado para 'on'

        const chat = await msg.getChat();

        await delay(1000); //delay de 3 segundos
        await chat.sendStateTyping(); // Simulando Digitação
        await delay(2000); //Delay de 3000 milisegundos mais conhecido como 3 segundos
        const contact = await msg.getContact(); //Pegando o contato
        const name = contact.pushname; //Pegando o nome do contato
        await client.sendMessage(msg.from, 'Olá, ' + name.split(". ")[0] + 'Eu sou a Lalá, assistente virtual do Condomínio T Lacerda. Digite uma das opções:\n\n1 - Boletos\n2 - Valores dos planos\n3 - Benefícios\n4 - Como aderir\n5 - Outras perguntas'); //Primeira mensagem de texto
    }

    if (msg.body !== null && msg.body === '1' && msg.from.endsWith('@c.us')) {
        const chat = await msg.getChat();

        if (status === 'on') {
            await delay(1000); //delay de 3 segundos
            await chat.sendStateTyping(); // Simulando Digitação
            await delay(2000);
            await client.sendMessage(msg.from, 'Nosso serviço oferece consultas médicas 24 horas por dia, 7 dias por semana, diretamente pelo WhatsApp.\n\nNão há carência, o que significa que você pode começar a usar nossos serviços imediatamente após a adesão.\n\nOferecemos atendimento médico ilimitado, receitas\n\nAlém disso, temos uma ampla gama de benefícios, incluindo acesso a cursos gratuitos');

            await delay(1000); //delay de 3 segundos
            await chat.sendStateTyping(); // Simulando Digitação
            await delay(2000);
            await client.sendMessage(msg.from, 'COMO FUNCIONA?\nÉ muito simples.\n\n1º Passo\nFaça seu cadastro e escolha o plano que desejar.\n\n2º Passo\nApós efetuar o pagamento do plano escolhido você já terá acesso a nossa área exclusiva para começar seu atendimento na mesma hora.\n\n3º Passo\nSempre que precisar');

            await delay(1000); //delay de 3 segundos
            await chat.sendStateTyping(); // Simulando Digitação
            await delay(2000);
            await client.sendMessage(msg.from, 'Link para cadastro: https://site.com');

            status = 'menuPrincipalUm';

            await chat.sendStateTyping(); // Simulando Digitação
            await delay(2000);
            await client.sendMessage(msg.from, 'Para retornar ao menu inicial digite 0');

        } else if (status === 'off') {
            await client.sendMessage(msg.from, 'Se quiser iniciar nossa conversa digite oi ou ola.');
        }
    }

    if (msg.body !== null && msg.body === '2' && msg.from.endsWith('@c.us')) {
        const chat = await msg.getChat();

        if (status === 'on') {
            await delay(1000); //Delay de 3000 milisegundos mais conhecido como 3 segundos
            await chat.sendStateTyping(); // Simulando Digitação
            await delay(2000);
            await client.sendMessage(msg.from, '*Plano Individual:* R$22,50 por mês.\n\n*Plano Família:* R$39,90 por mês, inclui você mais 3 dependentes.\n\n*Plano TOP Individual:* R$42,50 por mês, com benefícios adicionais como\n\n*Plano TOP Família:* R$79,90 por mês, inclui você mais 3 dependentes');

            await delay(1000); //delay de 3 segundos
            await chat.sendStateTyping(); // Simulando Digitação
            await delay(2000);
            await client.sendMessage(msg.from, 'Link para cadastro: https://site.com');

            status = 'menuPrincipalDois';

            await chat.sendStateTyping(); // Simulando Digitação
            await delay(2000);
            await client.sendMessage(msg.from, 'Para retornar ao menu inicial digite 0');

        } else if (status === 'off') {
            await client.sendMessage(msg.from, 'Se quiser iniciar nossa conversa digite oi ou ola.');
        }
    }

    if (msg.body !== null && msg.body === '0' && msg.from.endsWith('@c.us')) {
        const chat = await msg.getChat();

        if (status === 'menuPrincipalUm' || status === 'menuPrincipalDois') {
            await delay(1000); //Delay de 3000 milisegundos mais conhecido como 3 segundos
            await chat.sendStateTyping(); // Simulando Digitação
            await delay(2000);
            await client.sendMessage(msg.from, 'Menu principal. Digite uma das opções:\n\n1 - Boletos\n2 - Valores dos planos\n3 - Benefícios\n4 - Como aderir\n5 - Outras perguntas'); //Primeira mensagem de texto

            status = 'on';

        } else if (status === 'off') {
            await client.sendMessage(msg.from, 'Se quiser iniciar nossa conversa digite oi ou ola.');
        }
    }

});